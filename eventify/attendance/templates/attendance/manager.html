{% extends "base.html" %}
{% load static %}

{% block title %}Attendance Manager | Eventify{% endblock %}

{% block content %}
<section>
  <div class="max-w-4xl mx-auto px-6">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Attendance Manager</h1>
      <p class="text-gray-600">Use this console to check people in/out. Only organizers and volunteers can perform actions.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">Manual Check</h2>
        <form id="attendance-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input id="email" name="email" type="email" required class="mt-1 block w-full rounded-lg border-gray-300 px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="participant@example.com">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Event ID</label>
            <input id="eventID" name="eventID" type="text" readonly class="mt-1 block w-full rounded-lg border-gray-300 px-3 py-2 bg-gray-50" value="{{ eventID }}">
            <input type="hidden" id="eventID-hidden" value="{{ eventID }}">
          </div>

          <div class="flex gap-3">
            <button type="button" id="checkin-btn" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold">Check In</button>
            <button type="button" id="checkout-btn" class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg font-semibold">Check Out</button>
          </div>

          <div id="attendance-status" class="text-sm mt-2"></div>
        </form>
      </div>

      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">QR Scanner</h2>
        <div id="qr-reader" class="border-2 border-dashed border-gray-200 rounded-lg h-56 mb-4"></div>
        <div class="flex gap-3">
          <button id="scan-qr" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">Scan QR</button>
          <button id="stop-qr" class="px-4 py-2 bg-red-500 text-white rounded-lg">Stop Scanner</button>
        </div>
      </div>
    </div>
  </div>
</section>
  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <script>
function getCSRFToken(){
  return document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))?.split('=')[1];
}

  document.addEventListener('DOMContentLoaded', ()=>{
  const pageEventID = "{{ eventID }}";
  const status = document.getElementById('attendance-status');
  const doPost = (payload) => {
      const postUrl = window.location.pathname || '/attendance/manager/';
      fetch(postUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded', 'X-CSRFToken': getCSRFToken()},
      body: new URLSearchParams(payload)
    }).then(r=>r.json()).then(d=>{
      if(d.error) status.innerHTML = `<span class='text-red-600'>${d.error}</span>`;
      else status.innerHTML = `<span class='text-green-600'>Success</span>`;
    }).catch(e=>{ status.innerHTML = `<span class='text-red-600'>Request failed</span>`; console.error(e)});
  };

  document.getElementById('checkin-btn').addEventListener('click', ()=>{
    const email = document.getElementById('email').value.trim();
    if(!email || !pageEventID){ status.innerHTML = '<span class="text-red-600">Email and Event ID required</span>'; return; }
    doPost({email, action:'checkin', eventID: pageEventID});
  });

  document.getElementById('checkout-btn').addEventListener('click', ()=>{
    const email = document.getElementById('email').value.trim();
    if(!email || !pageEventID){ status.innerHTML = '<span class="text-red-600">Email and Event ID required</span>'; return; }
    doPost({email, action:'checkout', eventID: pageEventID});
  });

  document.getElementById('scan-qr').addEventListener('click', ()=>{
    // Start the camera scanner and listen for a single scan
    if(window._ev_qr_scanner) return; // already running
    const qrRegionId = 'qr-reader';
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    const onScanSuccess = (decodedText, decodedResult) => {
      // stop scanner
      try{
        window._ev_qr_scanner.clear().then(()=>{ window._ev_qr_scanner = null; });
      }catch(e){ window._ev_qr_scanner = null; }

      // try parse JSON payload
      let payload = {};
      try{ payload = JSON.parse(decodedText); }catch(e){ payload.email = decodedText; }

      const email = payload.email || document.getElementById('email').value.trim();
      const eventVal = payload.eventID || payload.eventID || pageEventID;
      if(email) document.getElementById('email').value = email;
      if(eventVal) document.getElementById('eventID').value = eventVal;

      // ask volunteer action
      const isCheckin = confirm('QR scanned for ' + (email||'user') + '.\n\nPress OK to mark CHECK IN, Cancel to mark CHECK OUT.');
      const action = isCheckin ? 'checkin' : 'checkout';
      doPost({ email: email, action: action, eventID: eventVal });
    };

    const onScanError = (errorMessage) => {
      // ignore intermittent scan errors
    };

    // create scanner instance and start
    try{
      const scanner = new Html5Qrcode(qrRegionId);
      window._ev_qr_scanner = scanner;
      scanner.start({ facingMode: "environment" }, config, onScanSuccess, onScanError).catch(err=>{
        console.error('QR start failed', err);
        document.getElementById('attendance-status').innerHTML = `<span class='text-red-600'>Camera start failed: ${err}</span>`;
        window._ev_qr_scanner = null;
      });
    }catch(e){
      console.error(e);
      document.getElementById('attendance-status').innerHTML = `<span class='text-red-600'>Scanner init error</span>`;
      window._ev_qr_scanner = null;
    }
  });

  document.getElementById('stop-qr').addEventListener('click', ()=>{
    if(window._ev_qr_scanner){
      window._ev_qr_scanner.clear().then(()=>{ window._ev_qr_scanner = null; document.getElementById('attendance-status').innerHTML = '<span class="text-gray-600">Scanner stopped</span>'; }).catch(()=>{ window._ev_qr_scanner = null; });
    }
  });
});
</script>

{% endblock %}