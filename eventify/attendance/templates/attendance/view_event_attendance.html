{% extends "base.html" %}
{% load static %}

{% block title %}Event Attendance | Eventify{% endblock %}

{% block content %}
<section>
  <div class="max-w-4xl mx-auto px-6">
    <div class="mb-6">
      <a href="/events" class="text-indigo-600 hover:underline">← Back to events</a>
      <h1 class="text-3xl font-bold mt-4">Event Attendance</h1>
      <p class="text-gray-600">Live attendance list for event ID: <strong>{{ eventID }}</strong></p>
    </div>

    <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
      <div id="attendance-loading" class="py-12 text-center text-gray-500">Loading attendance…</div>
      <div id="attendance-error" class="hidden py-8 text-center text-red-600"></div>
      <div id="attendance-actions" class="hidden py-4 text-right">
        <button id="download-csv" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold">Download CSV</button>
      </div>

      <div class="overflow-x-auto">
        <table id="attendance-table" class="w-full text-sm hidden">
          <thead class="bg-gray-50 border-b border-gray-200">
            <tr class="text-gray-700">
              <th class="px-6 py-3 text-left font-semibold">User</th>
              <th class="px-6 py-3 text-left font-semibold">Checked In</th>
              <th class="px-6 py-3 text-left font-semibold">Checked Out</th>
              <th class="px-6 py-3 text-left font-semibold">Checked In By</th>
              <th class="px-6 py-3 text-left font-semibold">Checked Out By</th>
            </tr>
          </thead>
          <tbody id="attendance-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const eventID = "{{ eventID }}";
  const loadingEl = document.getElementById('attendance-loading');
  const errorEl = document.getElementById('attendance-error');
  const tableEl = document.getElementById('attendance-table');
  const bodyEl = document.getElementById('attendance-body');

  fetch(`/attendance/api/v1/${eventID}/view/`, { credentials: 'same-origin' })
    .then(r=>r.json())
    .then(data=>{
      loadingEl.classList.add('hidden');
      if(data.error){ errorEl.classList.remove('hidden'); errorEl.textContent = data.error; return; }
      const items = data.attendances || [];
      // enable download action
      const actionsEl = document.getElementById('attendance-actions');
      const downloadBtn = document.getElementById('download-csv');
      let attendanceData = items;
      if(items.length){
        actionsEl.classList.remove('hidden');
        downloadBtn.addEventListener('click', ()=>{
          downloadAttendanceCSV(attendanceData, eventID);
        });
      }
      if(!items.length){ errorEl.classList.remove('hidden'); errorEl.textContent = 'No attendance records found.'; return; }
      tableEl.classList.remove('hidden');
      items.forEach(a=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `
          <td class="px-6 py-4 font-medium text-gray-900">${a.user}</td>
          <td class="px-6 py-4">${a.checkedIn ? 'Yes' : 'No'}</td>
          <td class="px-6 py-4">${a.checkedOut ? 'Yes' : 'No'}</td>
          <td class="px-6 py-4">${a.checkedInBy || '-'}</td>
          <td class="px-6 py-4">${a.checkedOutBy || '-'}</td>
        `;
        bodyEl.appendChild(tr);
      });
    })
    .catch(e=>{ loadingEl.classList.add('hidden'); errorEl.classList.remove('hidden'); errorEl.textContent = 'Failed to load attendance.'; console.error(e); });

  function downloadAttendanceCSV(rows, eventID){
    if(!rows || !rows.length) return;
    const headers = ['user','checkedIn','checkedOut','checkedInBy','checkedOutBy'];
    const csvRows = [headers.join(',')];
    rows.forEach(r=>{
      const vals = [
        `"${(r.user||'').replace(/"/g,'""')}"`,
        r.checkedIn ? 'Yes' : 'No',
        r.checkedOut ? 'Yes' : 'No',
        `"${(r.checkedInBy||'').replace(/"/g,'""') }"`,
        `"${(r.checkedOutBy||'').replace(/"/g,'""') }"`
      ];
      csvRows.push(vals.join(','));
    });
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const safeEvent = String(eventID).replace(/[^a-z0-9-_]/gi,'_');
    a.download = `attendance-${safeEvent}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
});
</script>

{% endblock %}