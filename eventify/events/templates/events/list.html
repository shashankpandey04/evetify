{% extends "base.html" %}
{% load static %}

{% block title %}Events{% endblock %}

{% block content %}
<section class="py-10 bg-gray-50">
<div class="max-w-7xl mx-auto px-6">

    <!-- HEADER -->
    <div class="mb-14">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-3">
            Discover Events
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl">
            Explore workshops, sessions and experiences happening around you.
        </p>
    </div>

    <!-- EVENTS GRID -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-10">

        {% for event in events %}
        <div class="group flex flex-col">

            <!-- CARD -->
            <div class="bg-white rounded-3xl p-6 transition
                        hover:shadow-2xl hover:-translate-y-1 duration-300">

                <!-- STATUS -->
                <span class="text-xs font-semibold text-indigo-600 uppercase tracking-wide">
                    {{ event.status }}
                </span>

                <!-- TITLE -->
                <h3 class="text-xl font-bold text-gray-900 mt-2 mb-3
                           group-hover:text-indigo-600 transition line-clamp-2">
                    {{ event.title }}
                </h3>

                <!-- META INFO -->
                <div class="space-y-3 text-sm text-gray-600">

                    <div class="flex items-center gap-3">
                        <i class="fa-regular fa-calendar text-indigo-500"></i>
                        <span>
                            {{ event.date|date:'M d, Y' }}
                            •
                            {{ event.startTime|date:'H:i' }} – {{ event.endTime|date:'H:i' }}
                        </span>
                    </div>

                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-location-dot text-indigo-500"></i>
                        <span>
                            {{ event.cityName }}, {{ event.countryName }}
                        </span>
                    </div>

                </div>

                <p class="mt-4 text-sm text-gray-600 line-clamp-3 leading-relaxed">
                    {{ event.description }}
                </p>

                <div class="flex gap-3 mt-6">

                    <a href="/events/{{ event.id }}/"
                       class="flex-1 text-center py-4 rounded-lg border border-gray-300
                              font-semibold text-gray-700 hover:border-indigo-400
                              hover:text-indigo-600 transition">
                        Details
                    </a>

                    <button
                        class="flex-1 register-btn py-2.5 rounded-lg font-semibold
                               bg-indigo-600 text-white hover:bg-indigo-700 transition"
                        data-event-id="{{ event.eventID }}"
                        data-is-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
                        Register
                    </button>

                </div>

            </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-24">
            <i class="fa-solid fa-calendar-xmark text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-500">No events available right now.</p>
        </div>
        {% endfor %}

    </div>
</div>
</section>

<script>
function getCSRFToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".register-btn");
    buttons.forEach(btn => {
        const eventID = btn.dataset.eventId;
        fetch(`/events/api/v1/is-registered/?eventID=${eventID}`)
            .then(res => res.json())
            .then(data => {
                updateButton(btn, data.is_registered);
            });
        btn.addEventListener("click", () => {
            if (btn.disabled) return;
            const registered = btn.dataset.registered === "true";
            const url = registered ? "/events/api/v1/unregister/" : "/events/api/v1/register/";
            fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/x-www-form-urlencoded" },
                body: `eventID=${eventID}`
            }).then(r => r.json()).then(d => {
                updateButton(btn, !registered);
            });
        });
    });
    function updateButton(btn, registered) {
        btn.dataset.registered = registered;
        if (btn.dataset.isAuthenticated === "false") {
            btn.disabled = true;
            btn.textContent = "Login Required";
            btn.classList.add("bg-gray-300", "text-gray-500", "cursor-not-allowed");
            btn.classList.remove("bg-indigo-600", "text-white");
        } else if (registered) {
            btn.textContent = "Unregister";
            btn.classList.add("bg-green-100", "text-green-700");
            btn.classList.remove("bg-indigo-600", "text-white");
        } else {
            btn.textContent = "Register";
            btn.classList.add("bg-indigo-600", "text-white");
            btn.classList.remove("bg-green-100", "text-green-700");
        }
    }
});
</script>
{% endblock %}