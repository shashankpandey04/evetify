{% extends "base.html" %}
{% load static %}

{% block title %}Events{% endblock %}

{% block content %}
<section class="py-6">
    <div class="max-w-7xl mx-auto px-6">
        <div class="mb-16 text-center">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">Discover Events</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">Find and register for amazing events. Connect with organizers and volunteers.</p>
        </div>
        
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for event in events %}
            <div class="group bg-white border border-gray-200 rounded-2xl overflow-hidden shadow-sm hover:shadow-xl hover:border-indigo-300 transition duration-300 flex flex-col">
                <div class="relative p-6 bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-indigo-600 transition">{{ event.title }}</h3>
                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 capitalize">{{ event.status }}</span>
                </div>
                <div class="flex-1 p-6 space-y-4">
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-calendar-days text-indigo-500 mt-1 flex-shrink-0"></i>
                        <div class="text-sm text-gray-700">
                            <div class="font-semibold">{{ event.date|date:'M d, Y' }}</div>
                            <div class="text-gray-600">{{ event.startTime|date:'H:i' }} - {{ event.endTime|date:'H:i' }}</div>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-3">
                        <i class="fa-solid fa-location-dot text-indigo-500 mt-1 flex-shrink-0"></i>
                        <div class="text-sm text-gray-700 font-medium">{{ event.location }}</div>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-3">{{ event.description }}</p>
                </div>
                <div class="p-6 border-t border-gray-200 bg-gray-50 flex gap-3">
                    <a href="/events/{{ event.id }}/" class="flex-1 px-4 py-2 bg-white border border-indigo-300 text-indigo-600 font-semibold rounded-lg hover:bg-indigo-50 transition text-center">Details</a>
                    <button class="flex-1 register-btn px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition" data-event-id="{{ event.eventID }}" data-is-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">Register</button>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-24">
                <i class="fa-solid fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-xl text-gray-500">No events found. Check back soon!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<script>
function getCSRFToken() {
    return document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
}

document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".register-btn");
    buttons.forEach(btn => {
        const eventID = btn.dataset.eventId;
        fetch(`/events/api/v1/is-registered/?eventID=${eventID}`)
            .then(res => res.json())
            .then(data => {
                updateButton(btn, data.is_registered);
            });
        btn.addEventListener("click", () => {
            if (btn.disabled) return;
            const registered = btn.dataset.registered === "true";
            const url = registered ? "/events/api/v1/unregister/" : "/events/api/v1/register/";
            fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken(), "Content-Type": "application/x-www-form-urlencoded" },
                body: `eventID=${eventID}`
            }).then(r => r.json()).then(d => {
                updateButton(btn, !registered);
            });
        });
    });
    function updateButton(btn, registered) {
        btn.dataset.registered = registered;
        if (btn.dataset.isAuthenticated === "false") {
            btn.disabled = true;
            btn.textContent = "Login Required";
            btn.classList.add("bg-gray-300", "text-gray-500", "cursor-not-allowed");
            btn.classList.remove("bg-indigo-600", "text-white");
        } else if (registered) {
            btn.textContent = "Unregister";
            btn.classList.add("bg-green-100", "text-green-700");
            btn.classList.remove("bg-indigo-600", "text-white");
        } else {
            btn.textContent = "Register";
            btn.classList.add("bg-indigo-600", "text-white");
            btn.classList.remove("bg-green-100", "text-green-700");
        }
    }
});
</script>
{% endblock %}